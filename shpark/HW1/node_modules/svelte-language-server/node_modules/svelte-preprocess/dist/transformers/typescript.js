"use strict";var __importDefault=this&&this.__importDefault||function(a){return a&&a.__esModule?a:{default:a}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.compileFileFromMemory=void 0;const fs_1=require("fs"),path_1=require("path"),typescript_1=__importDefault(require("typescript")),errors_1=require("../modules/errors");function createFormatDiagnosticsHost(a){return{getCanonicalFileName:a=>a,getCurrentDirectory:()=>a,getNewLine:()=>typescript_1.default.sys.newLine}}function formatDiagnostics(a,b){return Array.isArray(a)?typescript_1.default.formatDiagnosticsWithColorAndContext(a,createFormatDiagnosticsHost(b)):typescript_1.default.formatDiagnostic(a,createFormatDiagnosticsHost(b))}function getFilenameExtension(a){a=path_1.basename(a);const b=a.lastIndexOf(".");return 0>=b?"":a.substr(b+1)}function isSvelteFile(a){const b=getFilenameExtension(a);return"svelte"===b||"html"===b}const IMPORTEE_PATTERN=/['"](.*?)['"]/;function isValidSvelteImportDiagnostic(a,b){if(2307!==b.code)return!0;const c=b.messageText.match(IMPORTEE_PATTERN);if(!c)return!0;let[,d]=c;return!("."!==d[0])&&(!isSvelteFile(d)||(d=path_1.resolve(path_1.dirname(a),d),!1===fs_1.existsSync(d)))}const importTransformer=a=>{const b=c=>{var d;return typescript_1.default.isImportDeclaration(c)?(null===(d=c.importClause)||void 0===d?void 0:d.isTypeOnly)?typescript_1.default.createEmptyStatement():typescript_1.default.createImportDeclaration(c.decorators,c.modifiers,c.importClause,c.moduleSpecifier):typescript_1.default.visitEachChild(c,a=>b(a),a)};return a=>typescript_1.default.visitNode(a,b)},TS_TRANSFORMERS={before:[importTransformer]},TS2552_REGEX=/Cannot find name '\$([a-zA-Z0-9_]+)'. Did you mean '([a-zA-Z0-9_]+)'\?/i;function isValidSvelteReactiveValueDiagnostic(a,b){if(2552!==b.code)return!0;if(!isSvelteFile(a))return!0;if(!b.messageText.includes("$"))return!0;const[,c,d]=b.messageText.match(TS2552_REGEX)||[];return!(c&&d&&c===d)}function createImportTransformerFromProgram(a){const b=a.getTypeChecker();return a=>{const c=d=>{var e;if(!typescript_1.default.isImportDeclaration(d))return typescript_1.default.visitEachChild(d,a=>c(a),a);let f=d.importClause;if(d.importClause){if(null===(e=d.importClause)||void 0===e?void 0:e.isTypeOnly)return typescript_1.default.createEmptyStatement();if(f=typescript_1.default.getMutableClone(d.importClause),f.namedBindings&&typescript_1.default.isNamedImports(f.namedBindings)){const a=typescript_1.default.getMutableClone(f.namedBindings),c=[];f.namedBindings=void 0;for(const d of a.elements){const a=d.name,e=b.getSymbolAtLocation(a),f=b.getAliasedSymbol(e);f&&0<(f.flags&(typescript_1.default.SymbolFlags.TypeAlias|typescript_1.default.SymbolFlags.Interface))||c.push(d)}0<c.length&&(a.elements=typescript_1.default.createNodeArray(c,a.elements.hasTrailingComma),f.namedBindings=a)}if(null==f.namedBindings&&null==f.name)return typescript_1.default.createEmptyStatement()}return typescript_1.default.createImportDeclaration(d.decorators,d.modifiers,f,d.moduleSpecifier)};return a=>typescript_1.default.visitNode(a,c)}}function compileFileFromMemory(a,{filename:b,content:c}){let d,e=c;const f=typescript_1.default.createCompilerHost(a,!0),g=typescript_1.default.sys.resolvePath(b),h=a=>typescript_1.default.sys.resolvePath(a)===g,i={fileExists:a=>h(a)||f.fileExists(a),getCanonicalFileName:a=>h(a)?typescript_1.default.sys.useCaseSensitiveFileNames?a:a.toLowerCase():f.getCanonicalFileName(a),getSourceFile:(a,b,c,d)=>h(a)?typescript_1.default.createSourceFile(g,e,b):f.getSourceFile(a,b,c,d),readFile:a=>h(a)?c:f.readFile(a),writeFile:(a,b)=>{a.endsWith(".map")?d=b:e=b},directoryExists:f.directoryExists&&f.directoryExists.bind(f),getCurrentDirectory:f.getCurrentDirectory.bind(f),getDirectories:f.getDirectories.bind(f),getNewLine:f.getNewLine.bind(f),getDefaultLibFileName:f.getDefaultLibFileName.bind(f),resolveModuleNames:f.resolveModuleNames&&f.resolveModuleNames.bind(f),useCaseSensitiveFileNames:f.useCaseSensitiveFileNames.bind(f)},j=typescript_1.default.createProgram([g],a,i),k={before:[createImportTransformerFromProgram(j)]},l=j.emit(j.getSourceFile(g),void 0,void 0,void 0,k),m=[...l.diagnostics,...typescript_1.default.getPreEmitDiagnostics(j)].filter(a=>isValidSvelteImportDiagnostic(b,a)&&isValidSvelteReactiveValueDiagnostic(b,a));return{code:e,map:d,diagnostics:m}}exports.compileFileFromMemory=compileFileFromMemory;const transformer=({content:a,filename:b,options:c})=>{const d={moduleResolution:"node",target:"es6"};let e=process.cwd();if(!1!==c.tsconfigFile||c.tsconfigDirectory){const a=c.tsconfigDirectory||path_1.dirname(b),f=c.tsconfigFile||typescript_1.default.findConfigFile(a,typescript_1.default.sys.fileExists);if("string"==typeof f){e=path_1.dirname(f);const{error:a,config:b}=typescript_1.default.readConfigFile(f,typescript_1.default.sys.readFile);if(a)throw new Error(formatDiagnostics(a,e));Object.assign(d,b.compilerOptions)}}Object.assign(d,c.compilerOptions);const{errors:f,options:g}=typescript_1.default.convertCompilerOptionsFromJson(d,e);if(f.length)throw new Error(formatDiagnostics(f,e));const h={...g,allowNonTsExtensions:!0};if(h.target===typescript_1.default.ScriptTarget.ES3||h.target===typescript_1.default.ScriptTarget.ES5)throw new Error(`Svelte only supports es6+ syntax. Set your 'compilerOptions.target' to 'es6' or higher.`);let i,j,k;if(c.transpileOnly||h.transpileOnly?({outputText:i,sourceMapText:j,diagnostics:k}=typescript_1.default.transpileModule(a,{fileName:b,compilerOptions:h,reportDiagnostics:!1!==c.reportDiagnostics,transformers:TS_TRANSFORMERS})):({code:i,map:j,diagnostics:k}=compileFileFromMemory(h,{filename:b,content:a})),0<k.length){const a=k.some(a=>a.category===typescript_1.default.DiagnosticCategory.Error),b=formatDiagnostics(k,e);console.log(b),a&&errors_1.throwTypescriptError()}return{code:i,map:j,diagnostics:k,dependencies:[]}};exports.default=transformer;