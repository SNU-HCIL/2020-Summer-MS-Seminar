"use strict";var __importDefault=this&&this.__importDefault||function(a){return a&&a.__esModule?a:{default:a}};Object.defineProperty(exports,"__esModule",{value:!0});const postcss_1=__importDefault(require("postcss")),globalifySelector_1=require("../modules/globalifySelector"),selectorPattern=/:global(?!\()/,globalifyRulePlugin=a=>{a.walkRules(selectorPattern,a=>{const b=a.selectors.filter(a=>":global"!==a).map(a=>{const[b,...c]=a.split(selectorPattern);return 0===c.length?b:[b,...c.map(globalifySelector_1.globalifySelector)].map(a=>a.trim()).join(" ").trim()});return 0===b.length?void a.remove():void a.replaceWith(a.clone({selectors:b}))})},globalAttrPlugin=a=>{a.walkAtRules(/keyframes$/,a=>{a.params.startsWith("-global-")||a.replaceWith(a.clone({params:`-global-${a.params}`}))}),a.walkRules(a=>{var b;"keyframes"===(null===(b=null===a||void 0===a?void 0:a.parent)||void 0===b?void 0:b.name)||a.replaceWith(a.clone({selectors:a.selectors.map(globalifySelector_1.globalifySelector)}))})},transformer=async({content:a,filename:b,options:c,map:d,attributes:e})=>{const f=[globalifyRulePlugin,(null===e||void 0===e?void 0:e.global)&&globalAttrPlugin].filter(Boolean),{css:g,map:h}=await postcss_1.default(f).process(a,{from:b,map:!(!(null!==c&&void 0!==c)||!c.sourceMap)&&{prev:d}});return{code:g,map:h}};exports.default=transformer;